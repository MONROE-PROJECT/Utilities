#!/bin/bash

export PATH=/usr/bin/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

. /etc/default/monroe-experiments

echo 1 > /monroe/maintenance/enabled
echo "routine maintenance window" > /monroe/maintenance/reason

docker stop -t 0 $(docker ps -q) || true
systemctl stop docker || true

# unmount and delete all folders in /experiments
grep /experiments /proc/mounts | cut -f1 -d' ' | xargs umount || true
rm -r /experiments/monroe/*
rm -r /experiments/user/*

echo 0 > /monroe/maintenance/enabled
rm /monroe/maintenance/reason

# check for issues and restore maintenance flag
biteback -f

# redeploy and start continuous base experiments
monroe-experiments

# redeploy and schedule user experiments
atrm $(atq | cut -f1)
systemctl restart marvind
