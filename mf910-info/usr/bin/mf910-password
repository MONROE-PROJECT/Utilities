#!/bin/bash
# $1 = target interface
# $2 = management key (encoded)
# $3 = new wifi password

INTERFACE=$1
KEY=$2
NEWPASS=$3

echo -n "Identifying $INTERFACE... "
ADDRESS=$(ip -f inet -o addr show $1 2>/dev/null | sed -e 's|.*inet \(.*\)/.*|\1|g')
MODEM=$(echo $ADDRESS| sed -e 's/\.[0-9]*$/.1/g')
echo "$MODEM."

echo -n "Login... "
curl -sL --interface $INTERFACE 'http://'$MODEM'/goform/goform_set_cmd_process?isTest=false&goformId=LOGIN&password='$KEY -H 'Referer: http://'$MODEM'/index.html'

echo -n "Fetching IMEI... "
IMEI=$(curl -s -X GET --interface $INTERFACE 'http://'$MODEM'/goform/goform_get_cmd_process?'$MULTI'isTest=false&cmd=imei&page=0&data_per_page=500&mem_store=1&tags=10&order_by=order+by+id+desc' -H 'Referer: http://'$MODEM'/index.html')
echo $IMEI

echo -n "Updating wifi password... "
#curl -sL --interface $INTERFACE 'http://'$MODEM'/goform/goform_set_cmd_process?isTest=false&goformId=SET_WIFI_MULTI_BAND_SETTINGS&isTest=false&m_ssid_enable=0&m_band_enable=0&wifi_multi_band_set=1&security_mode=WPAPSKWPA2PSK&ssid='$SSID'&wifi_band=b&cipher=1&security_shared_mode=1&passphrase='$NEWPASS -H 'Referer: http://'$MODEM'/index.html'
