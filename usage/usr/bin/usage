#!/bin/bash
 
## usage: ./usage basedir sqlprefix interface [interface, ...]
## where: basedir = directory to store usage statistics in
##        interface = interface to monitor 

## TODO: refactoring - currently, this is the same script in monroe and host netns, 
## but the mapping op0-iccid is only possible by mixing both with ip netns exec.

BASEDIR=$1
SQLPREFIX=$2
MONTH=$(date +%Y-%m)
DIR=$BASEDIR/$MONTH

mkdir -p $DIR
MODEMS=$(curl -s http://localhost:88/modems/update)
DLB=$(curl -s http://localhost:88/dlb|jq -r '.interfaces[]')

for IF in "${@:3}"; do
  if [ ! -f /sys/class/net/$IF/statistics/rx_bytes ]; then continue; fi
  DLBDATA=$(echo $DLB | jq -r '. | select(.name=="'$IF'")')
  MODEMDATA=$(echo $MODEMS | jq -r '.[] | select(.ifname=="'$IF'")')
  IM=$(echo $DLBDATA | jq -r '.iccid // empty')
  if [ -z "$IM" ]; then
    IM=$(echo $DLBDATA | jq -r '.mac // empty')
  fi
  if [ -z "$IM" ]; then
    continue
  fi

  MNS=""
  if [ ! -z "$SQLPREFIX" ]; then 
    OP=$(usb2op $IF)
    if [ -z "$OP" ]; then
      continue
    fi
    IF=$OP
    MNS="ip netns exec monroe"
  fi;

  RX=$($MNS cat /sys/class/net/$IF/statistics/rx_bytes)
  TX=$($MNS cat /sys/class/net/$IF/statistics/tx_bytes)
  if [ -z "$RX"]; then continue; fi

  if [ -f $DIR/$IM.rx.last ]; then 
    RXL=$(cat $DIR/$IM.rx.last)
    TXL=$(cat $DIR/$IM.tx.last)
    RXT=$(cat $DIR/$IM.rx.total || echo 0)
    TXT=$(cat $DIR/$IM.tx.total || echo 0)
    RXD=$(($RX - $RXL))
    TXD=$(($TX - $TXL))

    if (( $RXD >= 0 )) && (( $TXD >= 0 )); then 
      RXT=$(($RXT + $RXD))
      echo $RXT > $DIR/$IM.rx.total
      TXT=$(($TXT + $TXD))
      echo $TXT > $DIR/$IM.tx.total
      echo $(($RXT + $TXT)) > $DIR/$IM.total

      if [ ! -z "$SQLPREFIX" ]; then 
        if (( $RXD > 0 )) || (( $TXD > 0 )); then 

          # NOTE: SQLPrefix is set only for the experiment namespace, to 
          # report data usage not captured by network listener
          # We use this condition to report to SQL and the experiment folder

          EXPERIMENT=$(docker ps --format {{.Image}} | grep 'monroe-' | head -n 1)
          # TODO: identify active experiment, if there are several

          if [ ! -z "$EXPERIMENT" ]; then 
            mkdir -p $BASEDIR/$EXPERIMENT
            EXRXT=$(cat $BASEDIR/$EXPERIMENT/$IM.rx.total || echo 0)
            EXTXT=$(cat $BASEDIR/$EXPERIMENT/$IM.tx.total || echo 0)
            EXT=$(cat $BASEDIR/$EXPERIMENT/$IM.total || echo 0)
            echo $(($EXRXT + $RXD)) > $BASEDIR/$EXPERIMENT/$IM.rx.total
            echo $(($EXTXT + $TXD)) > $BASEDIR/$EXPERIMENT/$IM.tx.total
            echo $(($EXT + $RXD + $TXD)) > $BASEDIR/$EXPERIMENT/$IM.total
          fi

          if [ ! -z "$MODEMDATA" ]; then
            IMEI=$(echo $MODEMDATA | jq -r .imei)
            IMSI=$(echo $MODEMDATA | jq -r .imsi)
            NOW=$(date +%s) # TODO: should be start, not end.
            echo "INSERT INTO DataUse(DeviceId,SimCardIccid,SimCardImsi,IntervalStart,RxData,TxData) VALUES('$IMEI','$ICCID','$IMSI',FROM_UNIXTIME($NOW),$RXD,$TXD) ON DUPLICATE KEY UPDATE RxData=RxData+$RXD, TxData=TxData+$TXD;" > ${SQLPREFIX}${NOW}.sql
          fi
        fi 
      fi
    fi 

  fi
  echo $RX > $DIR/$IM.rx.last
  echo $TX > $DIR/$IM.tx.last
  cp $DIR/$IM.rx.total $BASEDIR/$IM.rx.total
  cp $DIR/$IM.tx.total $BASEDIR/$IM.tx.total
  cp $DIR/$IM.total $BASEDIR/$IM.total
done
